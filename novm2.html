require([
    "esri/Map",
    "esri/views/MapView",
    "esri/layers/GraphicsLayer",
    "esri/widgets/Sketch",
    "esri/Graphic",
    "esri/layers/FeatureLayer",
    "esri/geometry/SpatialReference",
    "esri/geometry/support/webMercatorUtils"
], function (Map, MapView, GraphicsLayer, Sketch, Graphic, FeatureLayer, SpatialReference, webMercatorUtils) {

    // Create the map with hybrid imagery basemap
    const map = new Map({ basemap: "hybrid" });

    // MapView setup
    const view = new MapView({
        container: "viewDiv",
        map: map,
        center: [-79.5, 43.7], // Center on Ontario
        zoom: 7
    });

    // Graphics layer for points
    const graphicsLayer = new GraphicsLayer();
    map.add(graphicsLayer);

    // Sketch widget
    const sketch = new Sketch({
        layer: graphicsLayer,
        view: view,
        creationMode: "update"
    });

    view.ui.add(sketch, { position: "top-right" });

    // Store lat/long data
    const drawnPoints = [];

    // On create complete, convert coordinates to lat/long
    sketch.on("create", function (event) {
        if (event.state === "complete") {
            // Convert to lat/long using webMercatorUtils
            const latLongPoint = webMercatorUtils.webMercatorToGeographic(event.graphic.geometry);
            
            // Store as {latitude, longitude}
            drawnPoints.push({
                latitude: latLongPoint.y,
                longitude: latLongPoint.x
            });
        }
    });

    document.getElementById("submitPoints").onclick = function () {
        const userName = document.getElementById("userName").value;
        const userEmail = document.getElementById("userEmail").value;

        if (!userName || !userEmail) {
            alert("Please enter your name and email.");
            return;
        }
        if (drawnPoints.length === 0) {
            alert("No points to submit!");
            return;
        }

        // Submit lat/long points with name and email attributes
        const featureLayer = new FeatureLayer({
            url: "https://services5.arcgis.com/aGI9Mx1pvNKY7ehV/arcgis/rest/services/MapleTrees/FeatureServer"
        });

        const features = drawnPoints.map(point => new Graphic({
            geometry: {
                type: "point",
                latitude: point.latitude,
                longitude: point.longitude,
                spatialReference: SpatialReference.WGS84
            },
            attributes: {
                Name: userName,
                Email: userEmail
            }
        }));

        featureLayer.applyEdits({ addFeatures: features })
            .then(response => {
                console.log("Lat/Long points submitted successfully!", response);
                drawnPoints.length = 0; // Clear points array
                graphicsLayer.removeAll();

                // Confirmation message
                alert(`Thank you, ${userName}, for your planting map submission. We will contact you at ${userEmail}.`);
            })
            .catch(error => console.error("Error submitting points:", error));
    };
});
